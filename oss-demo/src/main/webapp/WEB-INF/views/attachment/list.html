<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>文件管理</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
<link rel="stylesheet" href="/layui/css/layui.css" media="all">
<link rel="stylesheet" href="/src/style/admin.css" media="all">
<link rel="stylesheet" href="/src/style/common.css" media="all">
<style type="text/css">
.page-container {
	background-color: #ffffff;
	margin: 20px;
	padding: 20px;
	display: flex;
	flex-direction: column;
}

.page-title {
	padding: 5px;
	height: 30px;
	line-height: 30px;
	zoom: 1;
}

.l {
	float: left !important;
	word-wrap: break-word;
}

.r {
	float: right !important;
	word-wrap: break-word;
}

.portfolio-area {
	margin-right: -20px;
	zoom: 1;
}

.portfolio-area li {
	position: relative;
	float: left;
	margin-right: 20px;
	width: 162px;
	height: 162px;
	margin-top: 20px;
}

.newFile {
	display: inline-block;
	width: 164px;
	height: 164px;
	border: 1px #eee solid;
	background-image:
		url("data:image/png;base64,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");
	background-repeat: no-repeat;
	background-position: center;
	cursor: pointer;
}

.portfolio-area li .picbox {
	width: 150px;
	height: 150px;
	overflow: hidden;
	text-align: center;
	vertical-align: middle;
	display: table-cell;
	line-height: 150px;
}

.portfolio-area li .picbox img {
	max-width: 150px;
	max-height: 150px;
	vertical-align: middle;
}

.portfoliobox {
	position: absolute;
	top: 0;
	left: 0;
	width: 152px;
	height: 152px;
	padding: 5px;
	border: solid 1px #eee;
	background-color: #fff;
}

.textbox {
	position: absolute;
	bottom: 0;
	left: 0;
	background: rgba(0, 0, 0, 0.6);
	width: 100%;
	z-index: 99;
	color: #ffffff;
	overflow-x: hidden;
	white-space: nowrap;
	text-overflow: ellipsis;
}

.portfolio-area li .checkbox {
	position: absolute;
	top: 10px;
	right: 5px;
	cursor: pointer;
	line-height: normal;
	margin-top: -4px;
	display: block;
}
</style>
</head>
<body>

	<div class="layui-fluid">
		<div class="layui-card">
			<div class="layui-form">
				<div class="layui-card-header layuiadmin-card-header-auto">
					<div class="layui-form-item">
						<div class="layui-inline">
							<label class="layui-form-label">分类名称</label>
							<div class="layui-input-block">
								<input type="text" id="type_name" name="type_name"
									placeholder="请输入分类名称" autocomplete="off" class="layui-input">
							</div>
						</div>
						<div class="layui-inline">
							<button class="layui-btn layuiadmin-btn-useradmin"
								data-type="reload">
								<i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
							</button>
							<button class="layui-btn layuiadmin-btn-useradmin layui-hide"
								style="background-color: #FF5722;"
								permission="attachmentType.del" data-type="batchdel">删除</button>
							<button class="layui-btn layuiadmin-btn-useradmin layui-hide"
								style="background-color: #ff7f0d;"
								permission="attachmentType.edit" data-type="move">移动到</button>
							<button class="layui-btn layuiadmin-btn-useradmin layui-hide"
								style="background-color: #ff7f0d;"
								permission="attachmentType.query" onclick="downFile()">下载</button>
						</div>
					</div>
				</div>

				<div class="layui-card-body" style="background-color: #f0f2fa;">
					<div style="padding-bottom: 10px;background-color: #ffffff;">
						<button class="layui-btn layuiadmin-btn-useradmin layui-hide"
							style="background-color: #1E9FFF" permission="attachmentType.add"
							data-type="add">新建文件分类</button>
					</div>

					<!-- 内容 -->
					<div id="fileContent"></div>
				</div>
			</div>
		</div>
	</div>

	<script src="/src/lib/jquery-1.10.2.min.js"></script>
	<script src="/src/lib/base.js"></script>
	<script src="/src/lib/utils.js"></script>
	<script src="/layui/layui.js"></script>
	<script>
		var permissions = window.top.permissions;
	
		//获取文件分类、文件信息
		function queryAttachmentList() {
			var type_name = $("#type_name").val();
			get({
				url : '/attachmentType/listAll',
				data : {
					type_name : type_name
				},
				success : function(res) {
					if (res.rescode == 200) {
						var data = res.data;
						console.log(data);
						var fileContent = $("#fileContent");
						fileContent.empty();
						for (var i = 0; i < data.length; i++) {
							fileContent.append(formatClassifyDom("classify_" + (i + 1), data[i]));
						}
						bindUploadBtn();
					} else {
						layer.msg(res.msg);
					}
				}
			})
		}
		//组装数据
		function formatClassifyDom(classifyId, catalog) {
			var html = "";
			html += "<div class=\"page-container\" style='line-height: 30px;'>";
			html += "<div class=\"page-title\">";
			html += "<span class=\"l\">文件分类名称：" + catalog.type_name + "</span>";
			var loginUserId = $("#loginUserId").val();
			var loginUserId = catalog.loginUserId;
			var typeCreateby = catalog.createby;
			if (typeCreateby != null && typeCreateby != "" && typeCreateby != loginUserId) {
				html += "<span class=\"r\">共有数据：<strong>" + catalog.attachmentSize + "</strong> 条&emsp;<a href=\"javascript:void(0);\"  class=\"layui-btn layui-btn-danger layui-btn-xs\"><i class=\"layui-icon layui-icon-delete\"></i> 删除此类型</a></span>";
			} else {
				html += "<span class=\"r\">共有数据：<strong>" + catalog.attachmentSize + "</strong> 条&emsp;<a href=\"javascript:void(0);\" onclick=\"deleteClassify('" + catalog.id + "');\" class=\"layui-btn layui-btn-danger layui-btn-xs\"><i class=\"layui-icon layui-icon-delete\"></i> 删除此类型</a></span>";
			}
			html += "</div>";
			html += "<div class=\"portfolio-content\">";
			html += "<ul id=\"" + classifyId + "\" class=\"portfolio-area\">";
			var attachmentList = catalog.attachmentList;
			for (var i = 0; i < attachmentList.length; i++) {
				var param = attachmentList[i];
				if (null != param.file_url) {
					html += formatFileDom(param.a_id, param.file_url, param.a_name, param.a_createby);
				}
			}
			html += formatNewFileDom(catalog.id);
			html += "</ul>";
			html += "</div>";
			html += "</div>";
			return html;
		}
		//文件格式处理
		function formatFileDom(fileId, imageUrl, fileName, czUserId) {
		    var file_url = imageUrl;
			var fileExt = imageUrl.substring(imageUrl.lastIndexOf(".") + 1, imageUrl.length).toLowerCase();
			if (fileExt == "xlsx") {
				fileExt = "xls";
			} else if (fileExt == "docx") {
				fileExt = "doc";
			}
			var fileIcon = imageUrl;
			if (null == fileExt || "" == fileExt) {
				imageUrl = "javascript:void(0);";
			} else if ("jpg" == fileExt || "png" == fileExt || "gif" == fileExt || "bmp" == fileExt) {
	
			} else if (
				"txt" == fileExt ||
				"pdf" == fileExt ||
				"rar" == fileExt ||
				"zip" == fileExt ||
				"xls" == fileExt ||
				"doc" == fileExt
			) {
				imageUrl = "javascript:void(0);";
				fileIcon = "../../../images/fileIcon_" + fileExt + ".png";
			} else {
				imageUrl = "javascript:void(0);";
				fileIcon = "../../../images/fileIcon_file.png";
			}
			var html = "";
			html += "<li class=\"item\">";
			html += "<div class=\"portfoliobox\">";
			html += "<input class=\"checkbox\" name=\"a_id\" type=\"checkbox\" value=\"" + fileId + "\" data-id=\"" + czUserId + "\" data-url=\"" + file_url + "\">";
			if ("jpg" == fileExt || "png" == fileExt || "gif" == fileExt || "bmp" == fileExt) {
				html += "<div class=\"picbox\"><a target=\"_blank\" href=\"" + imageUrl + "\" data-lightbox=\"gallery\" data-title=\"" + fileName + "\"><img src=\"" + fileIcon + "\"></a></div>";
			} else {
				html += "<div class=\"picbox\"><img src=\"" + fileIcon + "\"></div>";
			}
			html += "</div>";
			html += "<div class=\"textbox\" title=\"" + fileName + "\">" + fileName + "</div>";
			html += "</li>";
			return html;
		}
		//组装空数据
		function formatNewFileDom(typeId) {
			var layerUploadParam = "lay-data=\"{url:'/oss_file/upload_attachment',accept:'file',size:204800,data:{id:" + typeId + "}}\"";
			var html = "";
			html += "<li class=\"item\"><div class=\"newFile demoMore\" " + layerUploadParam + "></div></li>";
			return html;
		}
		function bindUploadBtn() {
			var loadIndex;
			var uploadInst = upload.render({
				elem : '.demoMore',
				before : function() {
					loadIndex = layer.load();
				},
				done : function(res, index, upload) {
					if (res.code == "success") {
						layer.close(loadIndex);
						layer.msg('上传成功，页面即将刷新', {
							icon : 1,
							time : 2000 //2秒关闭
						}, function() {
							queryAttachmentList();
						});
					} else {
						layer.msg("上传失败！失败原因：" + res.msg, {
							icon : 2,
							time : 3000
						}, function() {
							layer.close(loadIndex);
						});
					}
				},
				error : function(index, upload) {
					layer.msg("上传失败，即将重新上传，请稍后！", {
						icon : 2,
						time : 1000
					});
					uploadInst.upload();
				}
			});
		}
		//删除文件分类
		function deleteClassify(id) {
			layer.confirm("确定要删除该类型及其以下所有文件吗？", function(index) {
				get({
					url : '/attachmentType/updateDelFlag',
					data : {
						id : id
					},
					success : function(res) {
						if (res.rescode == 200) {
							layer.msg('删除成功！', {
								icon : 1,
								time : 2000 //2秒关闭
							}, function() {
								layer.close(index);
								queryAttachmentList();
							});
	
						} else {
							layer.msg('删除失败！', {
								icon : 2,
								time : 2000 //2秒关闭
							}, function() {
								queryAttachmentList();
							});
						}
					}
				})
	
			});
		}
		//下载文件
		function downFile(){
		    var ids = [];
		    var urls=[];
			$("input[name='a_id']").each(function(i) {
				if ($(this).is(":checked")) {
					ids.push($(this).val())
					urls.push($(this).data("url"))
				}
			});

			if (ids.length != 1) {
				layer.msg("请选择一项进行下载！");
				return false;
			}
			window.location.href='/attachmentType/downFile?f_id='+ids[0]+"&url="+urls[0];

		}
		var upload;
		layui.config({
			base : "/src/" //静态资源所在路径
		}).extend({
			index : "index" //主入口模块
		}).use([ "index", "jquery", "upload", "table" ], function() {
			var $ = layui.$;
			var form = layui.form;
			var table = layui.table;
			upload = layui.upload;
	
			// 新增文件分类  
			if (permissions['attachmentType.add']) {
				$("[permission='attachmentType.add']").removeClass('layui-hide');
			}
			// 删除文件分类 
			if (permissions['attachmentType.del']) {
				$("[permission='attachmentType.del']").removeClass('layui-hide');
			}
			// 修改文件分类 
			if (permissions['attachmentType.edit']) {
				$("[permission='attachmentType.edit']").removeClass('layui-hide');
			}
			// 下载文件分类 
			if (permissions['attachmentType.query']) {
				$("[permission='attachmentType.query']").removeClass('layui-hide');
			}
			queryAttachmentList();
			//监听搜索
			var $ = layui.$,
				active = {
					reload : function() {
						queryAttachmentList();
					},
					add : function() {
						console.log("add")
						var modalIndex = layer.open({
							type : 2,
							title : "新建文件分类",
							maxmin : true,
							content : "addAttachmentType.html",
							area : [ "600px", "600px" ],
							btn : [ "确定", "取消" ],
							yes : function(index, layero) {
								var iframeWindow = window['layui-layer-iframe' + index],
									submit = layero.find('iframe').contents().find("#LAY-attachmentType-submit");
	
								//监听提交
								iframeWindow.layui.form.on('submit(LAY-attachmentType-submit)', function(data) {
									var field = data.field; //获取提交的字段
									var param = {};
									$.each(field, function(key, val) {
										if (key == 'ids') {
											param[key] = JSON.parse(val);
										} else {
											param[key] = val;
										}
									});
									//提交数据
									post({
										url : "/attachmentType/add",
										data : JSON.stringify(param),
										contentType : "application/json",
										success : function(json) {
											if (json.rescode == 200) {
												layer.close(index); //关闭弹层
												layer.msg("添加成功", {
													icon : 1
												});
												queryAttachmentList();
											} else {
												layer.msg(json.msg);
											}
										}
									});
								});
	
								submit.trigger('click');
							}
						});
						layer.full(modalIndex);
					},
					//批量删除文件
					batchdel : function() {
						var ids = [];
						$("input[name='a_id']").each(function(i) {
							if ($(this).is(":checked")) {
								ids.push($(this).val())
							}
						});
	
						if (ids.length == 0) {
							layer.msg("请选择要删除的数据");
							return false;
						}
	
						layer.confirm("确定删除吗？", function(index) {
							post({
								url : "/attachmentType/delAttachmentByIds",
								data : JSON.stringify(ids),
								dataType : "json",
								contentType : "application/json",
								success : function(json) {
									if (json.rescode == 200) {
	
										layer.msg('删除成功！', {
											icon : 1,
											time : 2000 //2秒关闭
										}, function() {
											layer.close(index);
											queryAttachmentList();
										});
	
									} else {
										layer.msg('删除失败！', {
											icon : 2,
											time : 2000 //2秒关闭
										}, function() {
											queryAttachmentList();
										});
									}
	
								},
								error : function() {
									layer.msg("请求失败");
								}
							});
						});
					},
					//移动文件
					move : function() {
						var ids = [];
						$("input[name='a_id']").each(function(i) {
							if ($(this).is(":checked")) {
								ids.push($(this).val())
							}
						});
	
						if (ids.length != 1) {
							layer.msg("请选择一项进行移动！");
							return false;
						}
	
						layui.a_id = ids[0];
						var modalIndex = layer.open({
							type : 2,
							title : "移动文件",
							maxmin : true,
							content : "moveAttachment.html",
							area : [ "600px", "400px" ],
							btn : [ "确定", "取消" ], 
							yes : function(index, layero) {
								var iframeWindow = window['layui-layer-iframe' + index],
									submit = layero.find('iframe').contents().find("#LAY-moveAttachment-submit");
	
								//监听提交
								iframeWindow.layui.form.on('submit(LAY-moveAttachment-submit)', function(data) {
									var field = data.field; //获取提交的字段
									console.log(field)
	
									get({
										url : '/attachmentType/moveAttachment',
										data : {
											a_id : field.a_id,
											type_id : field.type_id
										},
										success : function(res) {
											if (res.rescode == 200) {
												layer.msg('文件所属分类修改成功！', {
													icon : 1,
													time : 2000 //2秒关闭
												}, function() {
													layer.close(index);
													queryAttachmentList();
												});
	
											} else {
												layer.msg('操作失败！', {
													icon : 2,
													time : 2000 //2秒关闭
												}, function() {
													queryAttachmentList();
												});
											}
										}
									})
								});
	
								submit.trigger('click');
							}
						});
					/* layer.full(modalIndex); */
					}
				};
	
			$('.layui-btn.layuiadmin-btn-useradmin').on('click', function() {
				var type = $(this).data('type');
				active[type] ? active[type].call(this) : '';
			});
		});
	</script>
</body>
</html>